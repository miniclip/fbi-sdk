!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("MCInstant",[],t):"object"==typeof exports?exports.MCInstant=t():e.MCInstant=t()}(window,function(){return function(e){var t={};function n(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(s,r,function(t){return e[t]}.bind(null,r));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=17)}([function(e,t,n){"use strict";var s=n(8),r=n(23),i=Object.prototype.toString;function o(e){return"[object Array]"===i.call(e)}function a(e){return null!==e&&"object"==typeof e}function c(e){return"[object Function]"===i.call(e)}function u(e,t){if(null!=e)if("object"!=typeof e&&(e=[e]),o(e))for(var n=0,s=e.length;n<s;n++)t.call(null,e[n],n,e);else for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.call(null,e[r],r,e)}e.exports={isArray:o,isArrayBuffer:function(e){return"[object ArrayBuffer]"===i.call(e)},isBuffer:r,isFormData:function(e){return"undefined"!=typeof FormData&&e instanceof FormData},isArrayBufferView:function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&e.buffer instanceof ArrayBuffer},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isObject:a,isUndefined:function(e){return void 0===e},isDate:function(e){return"[object Date]"===i.call(e)},isFile:function(e){return"[object File]"===i.call(e)},isBlob:function(e){return"[object Blob]"===i.call(e)},isFunction:c,isStream:function(e){return a(e)&&c(e.pipe)},isURLSearchParams:function(e){return"undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams},isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product)&&"undefined"!=typeof window&&"undefined"!=typeof document},forEach:u,merge:function e(){var t={};function n(n,s){"object"==typeof t[s]&&"object"==typeof n?t[s]=e(t[s],n):t[s]=n}for(var s=0,r=arguments.length;s<r;s++)u(arguments[s],n);return t},extend:function(e,t,n){return u(t,function(t,r){e[r]=n&&"function"==typeof t?s(t,n):t}),e},trim:function(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.NETWORK="network",e.WALLET="wallet",e.CHALLENGES="challenges",e.SESSION="session",e.CURRENCIES="currencies",e.INSTANT_STORAGE="storage",e.GLOBAL_STORE="global_store",e.EVENTS="events",e.MESSAGES="messages",e.LOBBY="lobby"}(t.Modules||(t.Modules={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.ONLINE_FRIENDS="online_friends",e.FRIEND_ONLINE="friend_online",e.OK="ok",e.POST="post",e.POST_FAILURE="post_failure",e.LOGIN_FAILURE="login_failure",e.LOGIN_SUCCESS="login_success"}(t.ResponseTypes||(t.ResponseTypes={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.BaseService=class{constructor(){this.container=null}_boot(){}setContainer(e){return this.container=e,this}get events(){return this.container.events}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EVENT_CHALLENGE_ENDED="challenge_ended",t.EVENT_WALLET_BALANCE_UPDATED="wallet_balance_updated",t.EVENT_WS_CONNECTED="ws_connected",t.EVENT_FRIEND_ONLINE="friend_online"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(2);t.SocketMessageHandler=class{constructor(e){this.handlers=new Map,this.postHandlers=new Map,e.registerHandler("message",e=>{if("pong"===e.data)return;const t=e.data?JSON.parse(e.data):null,n=this.handlers.get(t.type);if(n)for(const e of n)e(t);if(t.type===s.ResponseTypes.POST){const e=t,n=this.postHandlers.get(e.id);if(n)for(const e of n)e(t)}})}registerHandler(e,t){let n=this.handlers.get(e);n?n.push(t):((n=new Array).push(t),this.handlers.set(e,n))}unregisterHandler(e,t){const n=this.handlers.get(e);if(n){const e=n.indexOf(t);e>-1&&n.splice(e,1)}}registerPostHandler(e,t){let n=this.postHandlers.get(e);n?n.push(t):((n=new Array).push(t),this.postHandlers.set(e,n))}unregisterPostHandler(e,t){const n=this.postHandlers.get(e);if(n){const e=n.indexOf(t);e>-1&&n.splice(e,1)}}}},function(e,t,n){"use strict";(function(t){var s=n(0),r=n(26),i={"Content-Type":"application/x-www-form-urlencoded"};function o(e,t){!s.isUndefined(e)&&s.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var a,c={adapter:("undefined"!=typeof XMLHttpRequest?a=n(9):void 0!==t&&(a=n(9)),a),transformRequest:[function(e,t){return r(t,"Content-Type"),s.isFormData(e)||s.isArrayBuffer(e)||s.isBuffer(e)||s.isStream(e)||s.isFile(e)||s.isBlob(e)?e:s.isArrayBufferView(e)?e.buffer:s.isURLSearchParams(e)?(o(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString()):s.isObject(e)?(o(t,"application/json;charset=utf-8"),JSON.stringify(e)):e}],transformResponse:[function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,validateStatus:function(e){return e>=200&&e<300}};c.headers={common:{Accept:"application/json, text/plain, */*"}},s.forEach(["delete","get","head"],function(e){c.headers[e]={}}),s.forEach(["post","put","patch"],function(e){c.headers[e]=s.merge(i)}),e.exports=c}).call(this,n(25))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(19);let r=0;var i;!function(e){e.ERROR="error",e.WARN="warn",e.INFO="info",e.DEBUG="debug"}(i=t.LogLevel||(t.LogLevel={}));const o=s.methodFactory;function a(){}s.methodFactory=function(e,t,n){const s=o(e,t,n);return function(){const t=[`[${e.toUpperCase()}]`,n];for(let e=0;e<arguments.length;e+=1)t.push(arguments[e]);s.apply(void 0,t)}},t.getLogger=function(e){const t=r;return r+=1,s.getLogger(e+t)},t.loggerFromLoggingFunc=function(e,t){const n=r;r+=1;const o=s.getLogger(e+n);return o.methodFactory=function(e,n,s){return o=n,((r=e)===i.DEBUG?o<=1:r===i.INFO?o<=2:r===i.WARN?o<=3:r!==i.ERROR||o<=4)?function(...n){t(e,`${s} ${n.map(e=>JSON.stringify(e)).join(" ")}`)}:a;var r,o},o}},function(e,t,n){"use strict";e.exports=function(e,t){return function(){for(var n=new Array(arguments.length),s=0;s<n.length;s++)n[s]=arguments[s];return e.apply(t,n)}}},function(e,t,n){"use strict";var s=n(0),r=n(27),i=n(29),o=n(30),a=n(31),c=n(10),u="undefined"!=typeof window&&window.btoa&&window.btoa.bind(window)||n(32);e.exports=function(e){return new Promise(function(t,l){var d=e.data,h=e.headers;s.isFormData(d)&&delete h["Content-Type"];var f=new XMLHttpRequest,p="onreadystatechange",g=!1;if("undefined"==typeof window||!window.XDomainRequest||"withCredentials"in f||a(e.url)||(f=new window.XDomainRequest,p="onload",g=!0,f.onprogress=function(){},f.ontimeout=function(){}),e.auth){var y=e.auth.username||"",_=e.auth.password||"";h.Authorization="Basic "+u(y+":"+_)}if(f.open(e.method.toUpperCase(),i(e.url,e.params,e.paramsSerializer),!0),f.timeout=e.timeout,f[p]=function(){if(f&&(4===f.readyState||g)&&(0!==f.status||f.responseURL&&0===f.responseURL.indexOf("file:"))){var n="getAllResponseHeaders"in f?o(f.getAllResponseHeaders()):null,s={data:e.responseType&&"text"!==e.responseType?f.response:f.responseText,status:1223===f.status?204:f.status,statusText:1223===f.status?"No Content":f.statusText,headers:n,config:e,request:f};r(t,l,s),f=null}},f.onerror=function(){l(c("Network Error",e,null,f)),f=null},f.ontimeout=function(){l(c("timeout of "+e.timeout+"ms exceeded",e,"ECONNABORTED",f)),f=null},s.isStandardBrowserEnv()){var v=n(33),E=(e.withCredentials||a(e.url))&&e.xsrfCookieName?v.read(e.xsrfCookieName):void 0;E&&(h[e.xsrfHeaderName]=E)}if("setRequestHeader"in f&&s.forEach(h,function(e,t){void 0===d&&"content-type"===t.toLowerCase()?delete h[t]:f.setRequestHeader(t,e)}),e.withCredentials&&(f.withCredentials=!0),e.responseType)try{f.responseType=e.responseType}catch(t){if("json"!==e.responseType)throw t}"function"==typeof e.onDownloadProgress&&f.addEventListener("progress",e.onDownloadProgress),"function"==typeof e.onUploadProgress&&f.upload&&f.upload.addEventListener("progress",e.onUploadProgress),e.cancelToken&&e.cancelToken.promise.then(function(e){f&&(f.abort(),l(e),f=null)}),void 0===d&&(d=null),f.send(d)})}},function(e,t,n){"use strict";var s=n(28);e.exports=function(e,t,n,r,i){var o=new Error(e);return s(o,t,n,r,i)}},function(e,t,n){"use strict";e.exports=function(e){return!(!e||!e.__CANCEL__)}},function(e,t,n){"use strict";function s(e){this.message=e}s.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},s.prototype.__CANCEL__=!0,e.exports=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.CallbackContainer=class{constructor(){this.callbacks={}}add(e,t){e in this.callbacks||(this.callbacks[e]=[]),-1==this.callbacks[e].findIndex(e=>e==t)&&this.callbacks[e].push(t)}hasFor(e){return e in this.callbacks}get(e){return this.hasFor(e)?this.callbacks[e]:[]}remove(e,t){if(!(e in this.callbacks))return;let n=this.callbacks[e].findIndex(e=>e==t);-1!=n&&(this.callbacks[e].splice(n,1),0==this.callbacks[e].length&&delete this.callbacks[e])}};t.Action=class{constructor(){this.listeners=[]}emit(){this.listeners.forEach(e=>{e()})}listen(e){-1==this.listeners.findIndex(t=>t==e)&&this.listeners.push(e)}unlisten(e){let t=this.listeners.findIndex(t=>t==e);-1!=t&&this.listeners.splice(t,1)}clear(){this.listeners=[]}};t.Action1=class{constructor(){this.listeners=[]}emit(e){this.listeners.forEach(t=>{t(e)})}listen(e){-1==this.listeners.findIndex(t=>t==e)&&this.listeners.push(e)}unlisten(e){let t=this.listeners.findIndex(t=>t==e);-1!=t&&this.listeners.splice(t,1)}clear(){this.listeners=[]}};t.Action2=class{constructor(){this.listeners=[]}emit(e,t){this.listeners.forEach(n=>{n(e,t)})}listen(e){-1==this.listeners.findIndex(t=>t==e)&&this.listeners.push(e)}unlisten(e){let t=this.listeners.findIndex(t=>t==e);-1!=t&&this.listeners.splice(t,1)}clear(){this.listeners=[]}}},function(e,t,n){e.exports=n(47).default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=n(53);t.Challenge=s.Challenge},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(54);class r{constructor(e){this._handler=e}getOtherPlayers(){return this._handler.getOtherPlayers()}getFriends(){return this._handler.getFriends()}}t.MCContext=r;const i=new r(new s.default);t.default=i},function(e,t,n){"use strict";function s(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}Object.defineProperty(t,"__esModule",{value:!0}),s(n(18)),s(n(15)),s(n(4))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(7),r=n(20),i=n(49),o=n(1),a=n(50),c=n(52),u=n(55),l=n(56),d=n(57),h=n(58),f=n(59),p=n(4),g=n(61);class y{constructor({environment:e=_.PRODUCTION,logLevel:t=s.LogLevel.INFO,app_id:n="",challenge_reward:v={value:100,currency:"points"},currencies:E=["points"]}){this.di=new a.default,this.logger=s.getLogger(y.loggerName),this.logger.setLevel(t);const m=this.di.bind(o.Modules.GLOBAL_STORE,new l.Store),w=new u.CurrencyService;w.clear(),w.addCurrencies(E),m.set("challenge_reward",v);const S=new r.NetworkManager({app_id:n,environment:e,container:this.di});this.di.bind(o.Modules.NETWORK,S),this.di.bind(o.Modules.MESSAGES,new f.MessagesService),this.di.bind(o.Modules.SESSION,new d.SessionService),this.di.bind(o.Modules.INSTANT_STORAGE,new h.InstantStorage),this.di.bind(o.Modules.CURRENCIES,w),this.di.bind(o.Modules.WALLET,new i.WalletService),this.di.bind(o.Modules.CHALLENGES,new c.ChallengeService),this.di.bind(o.Modules.LOBBY,new g.LobbyService),this.di.boot(),this.challenges=this.di.get(o.Modules.CHALLENGES),this.wallet=this.di.get(o.Modules.WALLET).publicWallet,this.lobby=this.di.get(o.Modules.LOBBY),this.messages=this.di.get(o.Modules.MESSAGES),S.connect().then(()=>{this.events.emit(p.EVENT_WS_CONNECTED)},()=>{console.log("Failed to connect")})}get events(){return this.di.events}}var _;y.loggerName="mc:instant",y.version="0.1.7",t.MCInstant=y,function(e){e.PRODUCTION="production",e.SANDBOX="sandbox"}(_=t.MCIEnvironment||(t.MCIEnvironment={}))},function(e,t,n){var s,r;!function(i,o){"use strict";void 0===(r="function"==typeof(s=function(){var e=function(){},t="undefined",n=["trace","debug","info","warn","error"];function s(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function r(t,s){for(var r=0;r<n.length;r++){var i=n[r];this[i]=r<t?e:this.methodFactory(i,t,s)}this.log=this.debug}function i(n,i,o){return function(n){"debug"===n&&(n="log");return typeof console!==t&&(void 0!==console[n]?s(console,n):void 0!==console.log?s(console,"log"):e)}(n)||function(e,n,s){return function(){typeof console!==t&&(r.call(this,n,s),this[e].apply(this,arguments))}}.apply(this,arguments)}function o(e,s,o){var a,c=this,u="loglevel";function l(){var e;if(typeof window!==t){try{e=window.localStorage[u]}catch(e){}if(typeof e===t)try{var n=window.document.cookie,s=n.indexOf(encodeURIComponent(u)+"=");-1!==s&&(e=/^([^;]+)/.exec(n.slice(s))[1])}catch(e){}return void 0===c.levels[e]&&(e=void 0),e}}e&&(u+=":"+e),c.name=e,c.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},c.methodFactory=o||i,c.getLevel=function(){return a},c.setLevel=function(s,i){if("string"==typeof s&&void 0!==c.levels[s.toUpperCase()]&&(s=c.levels[s.toUpperCase()]),!("number"==typeof s&&s>=0&&s<=c.levels.SILENT))throw"log.setLevel() called with invalid level: "+s;if(a=s,!1!==i&&function(e){var s=(n[e]||"silent").toUpperCase();if(typeof window===t)return;try{return void(window.localStorage[u]=s)}catch(e){}try{window.document.cookie=encodeURIComponent(u)+"="+s+";"}catch(e){}}(s),r.call(c,s,e),typeof console===t&&s<c.levels.SILENT)return"No console available for logging"},c.setDefaultLevel=function(e){l()||c.setLevel(e,!1)},c.enableAll=function(e){c.setLevel(c.levels.TRACE,e)},c.disableAll=function(e){c.setLevel(c.levels.SILENT,e)};var d=l();null==d&&(d=null==s?"WARN":s),c.setLevel(d,!1)}var a=new o,c={};a.getLogger=function(e){if("string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=c[e];return t||(t=c[e]=new o(e,a.getLevel(),a.methodFactory)),t};var u=typeof window!==t?window.log:void 0;return a.noConflict=function(){return typeof window!==t&&window.log===a&&(window.log=u),a},a.getLoggers=function(){return c},a})?s.call(t,n,t,e):s)||(e.exports=r)}()},function(e,t,n){"use strict";var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))(function(r,i){function o(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(o,a)}c((s=s.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=n(21),i=n(1),o=n(41),a=n(45),c=n(14),{isNetworkOrIdempotentRequestError:u}=n(14),l="auth-token",d="x-auth-token",h="x-fb-signature";t.NetworkManager=class{constructor({environment:e="production",container:t,app_id:n}){this.store=t.get(i.Modules.GLOBAL_STORE),this.axios=r.default.create({baseURL:this.getAPIEndpointURL(e,n)}),this.axios.interceptors.request.use(e=>(e.headers["Content-Type"]="application/json",new Promise(t=>{this.store.get(l)?(e.headers[d]=this.store.get(l),t(e)):this.getSignedMessage().then(n=>{e.headers[h]=n.getSignature(),t(e)}).catch(()=>{t(e)})}))),this.axios.interceptors.response.use(e=>{let t=e.status;if(t>=200&&t<=299){const t=e.headers[d];t&&this.store.set(l,t)}return e},e=>s(this,void 0,void 0,function*(){if(e.response&&401==e.response.status){this.store.set(l,null);try{let t=yield this.getSignedMessage();e.config.headers[h]=t.getSignature()}catch(e){console.error("failed to sign request",e)}}throw e})),c(this.axios,{retries:3,retryCondition:e=>u(e)||401==e.response.status,retryDelay:e=>500*e}),this.serverComm=new o.ServerCommsManager(""+n,new a.Socket(this.getWSEndpointURL(e)))}get(e,t){return this.axios.get(e,t)}post(e,t,n){return this.axios.post(e,t,n)}put(e,t,n){return this.axios.put(e,t,n)}delete(e,t){return this.axios.delete(e,t)}send(e){return this.serverComm.send(e)}connect(){return this.serverComm.connect()}getWS(){return this.serverComm}getSignedMessage(){return FBInstant.player.getSignedPlayerInfoAsync()}getAPIEndpointURL(e,t){var n="";switch(e){case"development":n="dev-mci-ws";break;case"sandbox":n="sandbox-mci-ws";break;default:n="prod-mci-ws"}return`https://${n}.miniclippt.com/apps/${t}`}getWSEndpointURL(e){var t="";switch(e){case"development":t="dev";break;default:t="prod"}return`wss://${t}-mci-os.miniclippt.com/ws`}}},function(e,t,n){e.exports=n(22)},function(e,t,n){"use strict";var s=n(0),r=n(8),i=n(24),o=n(6);function a(e){var t=new i(e),n=r(i.prototype.request,t);return s.extend(n,i.prototype,t),s.extend(n,t),n}var c=a(o);c.Axios=i,c.create=function(e){return a(s.merge(o,e))},c.Cancel=n(12),c.CancelToken=n(39),c.isCancel=n(11),c.all=function(e){return Promise.all(e)},c.spread=n(40),e.exports=c,e.exports.default=c},function(e,t){function n(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}
/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
e.exports=function(e){return null!=e&&(n(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&n(e.slice(0,0))}(e)||!!e._isBuffer)}},function(e,t,n){"use strict";var s=n(6),r=n(0),i=n(34),o=n(35);function a(e){this.defaults=e,this.interceptors={request:new i,response:new i}}a.prototype.request=function(e){"string"==typeof e&&(e=r.merge({url:arguments[0]},arguments[1])),(e=r.merge(s,{method:"get"},this.defaults,e)).method=e.method.toLowerCase();var t=[o,void 0],n=Promise.resolve(e);for(this.interceptors.request.forEach(function(e){t.unshift(e.fulfilled,e.rejected)}),this.interceptors.response.forEach(function(e){t.push(e.fulfilled,e.rejected)});t.length;)n=n.then(t.shift(),t.shift());return n},r.forEach(["delete","get","head","options"],function(e){a.prototype[e]=function(t,n){return this.request(r.merge(n||{},{method:e,url:t}))}}),r.forEach(["post","put","patch"],function(e){a.prototype[e]=function(t,n,s){return this.request(r.merge(s||{},{method:e,url:t,data:n}))}}),e.exports=a},function(e,t){var n,s,r=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function a(e){if(n===setTimeout)return setTimeout(e,0);if((n===i||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:i}catch(e){n=i}try{s="function"==typeof clearTimeout?clearTimeout:o}catch(e){s=o}}();var c,u=[],l=!1,d=-1;function h(){l&&c&&(l=!1,c.length?u=c.concat(u):d=-1,u.length&&f())}function f(){if(!l){var e=a(h);l=!0;for(var t=u.length;t;){for(c=u,u=[];++d<t;)c&&c[d].run();d=-1,t=u.length}c=null,l=!1,function(e){if(s===clearTimeout)return clearTimeout(e);if((s===o||!s)&&clearTimeout)return s=clearTimeout,clearTimeout(e);try{s(e)}catch(t){try{return s.call(null,e)}catch(t){return s.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function g(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];u.push(new p(e,t)),1!==u.length||l||a(f)},p.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=g,r.addListener=g,r.once=g,r.off=g,r.removeListener=g,r.removeAllListeners=g,r.emit=g,r.prependListener=g,r.prependOnceListener=g,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(e,t,n){"use strict";var s=n(0);e.exports=function(e,t){s.forEach(e,function(n,s){s!==t&&s.toUpperCase()===t.toUpperCase()&&(e[t]=n,delete e[s])})}},function(e,t,n){"use strict";var s=n(10);e.exports=function(e,t,n){var r=n.config.validateStatus;n.status&&r&&!r(n.status)?t(s("Request failed with status code "+n.status,n.config,null,n.request,n)):e(n)}},function(e,t,n){"use strict";e.exports=function(e,t,n,s,r){return e.config=t,n&&(e.code=n),e.request=s,e.response=r,e}},function(e,t,n){"use strict";var s=n(0);function r(e){return encodeURIComponent(e).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}e.exports=function(e,t,n){if(!t)return e;var i;if(n)i=n(t);else if(s.isURLSearchParams(t))i=t.toString();else{var o=[];s.forEach(t,function(e,t){null!=e&&(s.isArray(e)?t+="[]":e=[e],s.forEach(e,function(e){s.isDate(e)?e=e.toISOString():s.isObject(e)&&(e=JSON.stringify(e)),o.push(r(t)+"="+r(e))}))}),i=o.join("&")}return i&&(e+=(-1===e.indexOf("?")?"?":"&")+i),e}},function(e,t,n){"use strict";var s=n(0),r=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];e.exports=function(e){var t,n,i,o={};return e?(s.forEach(e.split("\n"),function(e){if(i=e.indexOf(":"),t=s.trim(e.substr(0,i)).toLowerCase(),n=s.trim(e.substr(i+1)),t){if(o[t]&&r.indexOf(t)>=0)return;o[t]="set-cookie"===t?(o[t]?o[t]:[]).concat([n]):o[t]?o[t]+", "+n:n}}),o):o}},function(e,t,n){"use strict";var s=n(0);e.exports=s.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),n=document.createElement("a");function r(e){var s=e;return t&&(n.setAttribute("href",s),s=n.href),n.setAttribute("href",s),{href:n.href,protocol:n.protocol?n.protocol.replace(/:$/,""):"",host:n.host,search:n.search?n.search.replace(/^\?/,""):"",hash:n.hash?n.hash.replace(/^#/,""):"",hostname:n.hostname,port:n.port,pathname:"/"===n.pathname.charAt(0)?n.pathname:"/"+n.pathname}}return e=r(window.location.href),function(t){var n=s.isString(t)?r(t):t;return n.protocol===e.protocol&&n.host===e.host}}():function(){return!0}},function(e,t,n){"use strict";var s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function r(){this.message="String contains an invalid character"}r.prototype=new Error,r.prototype.code=5,r.prototype.name="InvalidCharacterError",e.exports=function(e){for(var t,n,i=String(e),o="",a=0,c=s;i.charAt(0|a)||(c="=",a%1);o+=c.charAt(63&t>>8-a%1*8)){if((n=i.charCodeAt(a+=.75))>255)throw new r;t=t<<8|n}return o}},function(e,t,n){"use strict";var s=n(0);e.exports=s.isStandardBrowserEnv()?{write:function(e,t,n,r,i,o){var a=[];a.push(e+"="+encodeURIComponent(t)),s.isNumber(n)&&a.push("expires="+new Date(n).toGMTString()),s.isString(r)&&a.push("path="+r),s.isString(i)&&a.push("domain="+i),!0===o&&a.push("secure"),document.cookie=a.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}}},function(e,t,n){"use strict";var s=n(0);function r(){this.handlers=[]}r.prototype.use=function(e,t){return this.handlers.push({fulfilled:e,rejected:t}),this.handlers.length-1},r.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},r.prototype.forEach=function(e){s.forEach(this.handlers,function(t){null!==t&&e(t)})},e.exports=r},function(e,t,n){"use strict";var s=n(0),r=n(36),i=n(11),o=n(6),a=n(37),c=n(38);function u(e){e.cancelToken&&e.cancelToken.throwIfRequested()}e.exports=function(e){return u(e),e.baseURL&&!a(e.url)&&(e.url=c(e.baseURL,e.url)),e.headers=e.headers||{},e.data=r(e.data,e.headers,e.transformRequest),e.headers=s.merge(e.headers.common||{},e.headers[e.method]||{},e.headers||{}),s.forEach(["delete","get","head","post","put","patch","common"],function(t){delete e.headers[t]}),(e.adapter||o.adapter)(e).then(function(t){return u(e),t.data=r(t.data,t.headers,e.transformResponse),t},function(t){return i(t)||(u(e),t&&t.response&&(t.response.data=r(t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)})}},function(e,t,n){"use strict";var s=n(0);e.exports=function(e,t,n){return s.forEach(n,function(n){e=n(e,t)}),e}},function(e,t,n){"use strict";e.exports=function(e){return/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(e)}},function(e,t,n){"use strict";e.exports=function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}},function(e,t,n){"use strict";var s=n(12);function r(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise(function(e){t=e});var n=this;e(function(e){n.reason||(n.reason=new s(e),t(n.reason))})}r.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},r.source=function(){var e;return{token:new r(function(t){e=t}),cancel:e}},e.exports=r},function(e,t,n){"use strict";e.exports=function(e){return function(t){return e.apply(null,t)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(42),r=n(43),i=n(44),o=n(2),a=n(5),c=n(13),u=()=>{};t.ServerCommsManager=class extends a.SocketMessageHandler{constructor(e,t){super(t),this.isLoggedIn=!1,this.onConnect=new c.Action,this.socket=t,this.socket.registerHandler("open",()=>this.onSocketOpen()),this.socket.registerHandler("close",()=>this.onSocketClosed()),this.loginRequest=new s.LoginRequest(e),this.pingRequest=new i.PingRequest,this.requestsQueue=new Array,this.registerHandler(o.ResponseTypes.POST,e=>{e.payload.okConfirmation&&this.send(new r.OkRequest(e.payload.requestID,e.sender_id)).then(u,u)})}connect(){return new Promise((e,t)=>{this.requestsQueue.push(n=>{n?(this.onConnect.emit(),e()):t()}),this.socket.connect()})}onSocketOpen(){this.loginRequest.send(this.socket).then(()=>{this.isLoggedIn=!0,this.pingRequest.send(this.socket).then(u,u),this.resolveRequests(!0)},()=>this.resolveRequests(!1))}onSocketClosed(){this.isLoggedIn=!1,this.pingRequest.stop()}resolveRequests(e){for(;this.requestsQueue.length>0;){const t=this.requestsQueue.pop();t&&t(e)}}send(e){return new Promise((t,n)=>{this.isLoggedIn?e.send(this.socket).then(t,n):this.requestsQueue.push(s=>{s?e.send(this.socket).then(t,n):n()})})}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(2),r=n(5);t.LoginRequest=class{constructor(e,t=2){this.appID=e,this.retries=t}send(e){const t=new r.SocketMessageHandler(e);let n=0;return new Promise((r,i)=>{this.handleError=(()=>{t.unregisterHandler(s.ResponseTypes.LOGIN_SUCCESS,this.handleSuccess),t.unregisterHandler(s.ResponseTypes.LOGIN_FAILURE,this.handleError),e.unregisterHandler("error",this.sendMessage),i()}),this.sendMessage=(()=>{n++>this.retries?this.handleError():this.getSignature().then(()=>{e.send(this.stringify())},this.sendMessage)}),this.handleSuccess=(()=>r()),t.registerHandler(s.ResponseTypes.LOGIN_SUCCESS,this.handleSuccess),t.registerHandler(s.ResponseTypes.LOGIN_FAILURE,this.handleError),e.registerHandler("error",this.sendMessage),this.sendMessage()})}getSignature(){return this.signature?Promise.resolve():new Promise((e,t)=>{window.FBInstant.player.getSignedPlayerInfoAsync().then(t=>{this.signature=t.getSignature(),e()},t)})}stringify(){const e={type:"login",app_id:this.appID,"x-fb-signature":this.signature};return JSON.stringify(e)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(2);t.OkRequest=class{constructor(e,t){this.requestID=e,this.recipientID=t}send(e){return e.send(this.stringify()),Promise.resolve()}stringify(){return JSON.stringify({type:s.ResponseTypes.POST,recipient_id:this.recipientID,payload:{requestID:this.requestID},id:s.ResponseTypes.OK})}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.PingRequest=class{constructor(e=5e3){this.delay=e}send(e){return this.stop(),this.timer=setInterval(()=>{e.send("ping")},this.delay),Promise.resolve()}stop(){clearInterval(this.timer)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(46);t.Socket=class{constructor(e){this.handlers=new Map,this.url=e}registerHandler(e,t){let n=this.handlers.get(e);n?n.push(t):((n=new Array).push(t),this.handlers.set(e,n))}unregisterHandler(e,t){const n=this.handlers.get(e);if(n){const e=n.indexOf(t);e>-1&&n.splice(e,1)}}connect(e=5){if(this.socket&&1===this.socket.readyState)return;let t=0;const n=()=>{this.socket=new WebSocket(this.url),this.socket.onopen=(e=>{t=0,this.callHandlers("open",e)}),this.socket.onerror=(e=>{this.callHandlers("error",e)}),this.socket.onmessage=(e=>{this.callHandlers("message",e)}),this.socket.onclose=(r=>{this.callHandlers("close",r),++t<=e&&setTimeout(()=>{n()},s.getRetryMSDelay(t))})};n()}callHandlers(e,t){if(e){const n=this.handlers.get(e);if(n)for(const e of n)e(t)}}send(e){this.socket&&1===this.socket.readyState&&this.socket.send(e)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getRetryMSDelay=function(e){return 1e3*(e+2*Math.random()*e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isNetworkError=a,t.isRetryableError=l,t.isSafeRequestError=d,t.isIdempotentRequestError=h,t.isNetworkOrIdempotentRequestError=f,t.exponentialDelay=g,t.default=_;var s,r=n(48),i=(s=r)&&s.__esModule?s:{default:s};var o="axios-retry";function a(e){return!e.response&&Boolean(e.code)&&"ECONNABORTED"!==e.code&&(0,i.default)(e)}var c=["get","head","options"],u=c.concat(["put","delete"]);function l(e){return"ECONNABORTED"!==e.code&&(!e.response||e.response.status>=500&&e.response.status<=599)}function d(e){return!!e.config&&(l(e)&&-1!==c.indexOf(e.config.method))}function h(e){return!!e.config&&(l(e)&&-1!==u.indexOf(e.config.method))}function f(e){return a(e)||h(e)}function p(){return 0}function g(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=100*Math.pow(2,e);return t+.2*t*Math.random()}function y(e){var t=e[o]||{};return t.retryCount=t.retryCount||0,e[o]=t,t}function _(e,t){e.interceptors.request.use(function(e){return y(e).lastRequestTime=Date.now(),e}),e.interceptors.response.use(null,function(n){var s=n.config;if(!s)return Promise.reject(n);var r=function(e,t){return Object.assign({},t,e[o])}(s,t),i=r.retries,a=void 0===i?3:i,c=r.retryCondition,u=void 0===c?f:c,l=r.retryDelay,d=void 0===l?p:l,h=r.shouldResetTimeout,g=void 0!==h&&h,_=y(s);if(u(n)&&_.retryCount<a){_.retryCount+=1;var v=d(_.retryCount,n);if(function(e,t){e.defaults.agent===t.agent&&delete t.agent,e.defaults.httpAgent===t.httpAgent&&delete t.httpAgent,e.defaults.httpsAgent===t.httpsAgent&&delete t.httpsAgent}(e,s),!g&&s.timeout&&_.lastRequestTime){var E=Date.now()-_.lastRequestTime;s.timeout=Math.max(s.timeout-E-v,1)}return s.transformRequest=[function(e){return e}],new Promise(function(t){return setTimeout(function(){return t(e(s))},v)})}return Promise.reject(n)})}_.isNetworkError=a,_.isSafeRequestError=d,_.isIdempotentRequestError=h,_.isNetworkOrIdempotentRequestError=f,_.exponentialDelay=g,_.isRetryableError=l},function(e,t,n){"use strict";var s=["ETIMEDOUT","ECONNRESET","EADDRINUSE","ESOCKETTIMEDOUT","ECONNREFUSED","EPIPE"],r=["ENOTFOUND","ENETUNREACH","UNABLE_TO_GET_ISSUER_CERT","UNABLE_TO_GET_CRL","UNABLE_TO_DECRYPT_CERT_SIGNATURE","UNABLE_TO_DECRYPT_CRL_SIGNATURE","UNABLE_TO_DECODE_ISSUER_PUBLIC_KEY","CERT_SIGNATURE_FAILURE","CRL_SIGNATURE_FAILURE","CERT_NOT_YET_VALID","CERT_HAS_EXPIRED","CRL_NOT_YET_VALID","CRL_HAS_EXPIRED","ERROR_IN_CERT_NOT_BEFORE_FIELD","ERROR_IN_CERT_NOT_AFTER_FIELD","ERROR_IN_CRL_LAST_UPDATE_FIELD","ERROR_IN_CRL_NEXT_UPDATE_FIELD","OUT_OF_MEM","DEPTH_ZERO_SELF_SIGNED_CERT","SELF_SIGNED_CERT_IN_CHAIN","UNABLE_TO_GET_ISSUER_CERT_LOCALLY","UNABLE_TO_VERIFY_LEAF_SIGNATURE","CERT_CHAIN_TOO_LONG","CERT_REVOKED","INVALID_CA","PATH_LENGTH_EXCEEDED","INVALID_PURPOSE","CERT_UNTRUSTED","CERT_REJECTED"];e.exports=function(e){return!e||!e.code||(-1!==s.indexOf(e.code)||-1===r.indexOf(e.code))}},function(e,t,n){"use strict";var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))(function(r,i){function o(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(o,a)}c((s=s.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),i=n(3),o=n(4),a="_wallet";t.WalletService=class extends i.BaseService{constructor(){super(),this._wallet={}}_boot(){this._currencies=this.container.get(r.Modules.CURRENCIES),this._cloud=this.container.get(r.Modules.INSTANT_STORAGE),this._wallet=this._currencies.get().reduce((e,t)=>Object.assign({},e,{[t]:0}),{})}get currencies(){return this._wallet}getBalance(e){return s(this,void 0,void 0,function*(){let t=yield this._cloud.get(a);Object.keys(t).forEach(e=>{null==t[e]&&delete t[e]});let n=Object.assign({},Object.assign(this.currencies,t));return Object.keys(n).forEach(t=>{null!=e&&-1==e.indexOf(t)&&delete n[t]}),n})}setBalance(e,t){return new Promise((n,s)=>{if(!(e in this.currencies))throw new Error(e+" does not exist.");let r={};r[e]=t;const i=Object.assign(this.currencies,r);this._cloud.set(a,i).then(this._cloud.flush).then(e=>{this.events.emit(o.EVENT_WALLET_BALANCE_UPDATED),n(e)})})}updateBalance(e,t){return s(this,void 0,void 0,function*(){try{yield this.setBalance(t,e)}catch(e){return{}}return yield this.getBalance([t])})}addBalance(e,t){return s(this,void 0,void 0,function*(){let n=(yield this.getBalance())[t]||0;n+=e,console.log("Add balance by ",e,t);try{return yield this.setBalance(t,n),!0}catch(e){console.error(e)}return!1})}get publicWallet(){return this._publicWallet||(this._publicWallet=new c(this)),this._publicWallet}};class c{constructor(e){this.wallet=e}getBalance(e){return this.wallet.getBalance(e)}addBalance(e,t){return this.wallet.addBalance(e,t)}updateBalance(e,t){return this.wallet.updateBalance(e,t)}}t.PublicWallet=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(7),r=n(51),i=n(3);t.default=class{constructor(){this.modules={},this.logger=s.getLogger("dicontainer"),this.events=new r.EventEmitter}bind(e,t){return this.modules[e]=t,t instanceof i.BaseService&&(t.container=this),t}get(e){if(e in this.modules)return this.modules[e];throw new Error(`Failed to get ${e} module`)}boot(){Object.keys(this.modules).forEach(e=>{let t=this.modules[e];t instanceof i.BaseService&&t._boot()})}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.EventEmitter=class{constructor(){this.events={}}on(e,t){return"object"!=typeof this.events[e]&&(this.events[e]=[]),this.events[e].push(t),()=>this.removeListener(e,t)}removeListener(e,t){if("object"!=typeof this.events[e])return;const n=this.events[e].indexOf(t);n>-1&&this.events[e].splice(n,1)}removeAllListeners(){Object.keys(this.events).forEach(e=>this.events[e].splice(0,this.events[e].length))}emit(e,...t){"object"==typeof this.events[e]&&[...this.events[e]].forEach(e=>e.apply(this,t))}once(e,t){const n=this.on(e,(...e)=>{n(),t.apply(this,e)});return n}}},function(e,t,n){"use strict";var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))(function(r,i){function o(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(o,a)}c((s=s.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),i=n(15),o=n(3),a=n(4);t.ChallengeService=class extends o.BaseService{constructor(){super(),this.challenges=[],this.initialized=!1,this.initialFetchResolver=null,this.initialFetch=new Promise(e=>{this.initialFetchResolver=e})}_boot(){this.wallet=this.container.get(r.Modules.WALLET),this.network=this.container.get(r.Modules.NETWORK),this.store=this.container.get(r.Modules.GLOBAL_STORE)}updateList(){return s(this,void 0,void 0,function*(){const e=FBInstant.player.getID(),t="/players/"+e+"/challenges";try{const n=yield this.network.get(t);if(!Array.isArray(n.data))return[];let s=n.data;for(let t=0;t<s.length;t++){let n=new i.Challenge(this.container,e).parse(s[t]);(yield this.consumeChallenge(n))&&(n=void 0),s[t]=n}s=s.filter(e=>null!=e),this.challenges=s.length>0?s:[]}catch(e){console.error("Failed to fetch challenges",e),this.challenges=[]}return this.initialized=!0,this.challenges})}getAll(){return s(this,void 0,void 0,function*(){return new Promise(e=>{this.initialized?e(this.challenges):this.updateList().then(t=>{e(t)})})})}getByContext(e){return s(this,void 0,void 0,function*(){return(yield this.getAll()).find(t=>t.contextId==e)})}getByChallengeId(e){return s(this,void 0,void 0,function*(){return(yield this.getAll()).find(t=>t.challengeId==e)})}getFromToken(e){return s(this,void 0,void 0,function*(){return new Promise(t=>s(this,void 0,void 0,function*(){let n=this.create();if(n.loadShareToken(e)||t(void 0),null==n.challengeId)return void t(n);let s=yield this.getByChallengeId(n.challengeId);t(s||n)}))})}create({score:e=0,duration:t=604800}={}){let n=FBInstant.player.getID(),s=new i.Challenge(this.container,n);return s.setDuration(t).setScore(e).setContext(FBInstant.context.getID()),s}hasPlayerWon(e){let t=[];return(t=e.playerIds.map(t=>({id:t,score:e.getScore(t)})).sort((e,t)=>isFinite(e.score-t.score)?t.score-e.score:isFinite(e.score)?-1:1))[0].id==e.getPlayerId()}consumeChallenge(e){return s(this,void 0,void 0,function*(){if(!e||e.time_left>0||-1==e.time_left)return!1;const t="/players/"+FBInstant.player.getID()+"/challenges/"+e.challengeId;try{const n=(yield this.network.delete(t)).status;if(n<200||n>299)return!0;let s=this.store.get("challenge_reward",null);const r=this.hasPlayerWon(e);null!=s&&r&&this.wallet.addBalance(s.value,s.currency);let i={challenge:e.data,won:r,reward:s};return this.events.emit(a.EVENT_CHALLENGE_ENDED,i),!0}catch(e){console.error("Failed to consume: ",e)}return!1})}}},function(e,t,n){"use strict";var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))(function(r,i){function o(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(o,a)}c((s=s.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),i=n(16);t.Challenge=class{constructor(e,t){this._currentPlayer="",this._originalScore=0,this._data={type:"challenge",score:{},duration:604800,context_id:"",end_ts:-1,updated_ts:-1,version:1},this._session=e.get(r.Modules.SESSION),this._network=e.get(r.Modules.NETWORK),this._currentPlayer=t}parse(e){if(null==e)return;let{end_ts:t,updated_ts:n,context_id:s,challenge_id:r,other_player_id:i,player_id:o}=e,a="score"in e?e.score:{};return this._data.context_id=s||"",this._data.score=a,this._data.end_ts=t||-1,this._data.updated_ts=n||-1,this._data.challenge_id=r,this._data.other_player_id=i,this._data.player_id=o,this._originalScore=this.getPlayerScore(),this}setScore(e){if(null==this._currentPlayer)return console.error("Challenge current player hasn't been set"),this;let t=this._currentPlayer;return this._data.score[t]=e,this}setDuration(e){return this._data.duration=e,this}setContext(e){return this.data.context_id=e,this}setChallengeId(e){return this._data.challenge_id=e,this}hasScore(e){return null!=e&&!!(this._data.score&&e in this._data.score)}getScore(e){return null==e?NaN:this.hasScore(e)?this._data.score[e]:NaN}getPlayerId(){return this._currentPlayer}getChallengerId(){return this._data.player_id}getPlayerScore(){return this.getScore(this.getPlayerId())}playerHasScore(){return this.hasScore(this.getPlayerId())}getOpponentId(){return this._data.other_player_id&&this._data.other_player_id!=this._currentPlayer?this._data.other_player_id:this._data.player_id&&this._data.player_id!=this._currentPlayer?this._data.player_id:Object.keys(this._data.score).find(e=>e!=this._currentPlayer)}getOpponentScore(){return this.getScore(this.getOpponentId())}opponentHasScore(){return this.hasScore(this.getOpponentId())}get playerIds(){return Object.keys(this._data.score)}get duration(){return this._data.duration}get time_left(){if(!isFinite(this._data.end_ts)||this._data.end_ts<0)return-1;let e=Math.floor((new Date).getTime()/1e3);return Math.max(0,this._data.end_ts-e)}get expired(){return 0==this.time_left}get updated_at(){return this._data.updated_ts}get contextId(){return this._data.context_id}get challengeId(){return this._data.challenge_id}get data(){return this._data}getShareToken(){return JSON.stringify(this.data)}loadShareToken(e){try{if("string"==typeof e){let t=JSON.parse(e);this._data=t}else"object"==typeof e&&(this._data=e)}catch(e){return!1}return!0}save(){return s(this,void 0,void 0,function*(){let e=this._data.type,t=this._data.duration,n=this.contextId,s=(new Date).getTimezoneOffset(),r=this.getPlayerScore();if(null==r)return console.error("The score for current player hasn't been set."),!1;isFinite(this._originalScore)&&(r-=this._originalScore);const o=this.getPlayerId();var a={context_id:n,score:r,duration:t,timezone_offset:s};try{var c;if(this.challengeId)c=yield this._network.put(`/players/${o}/challenges/${this.challengeId}`,a);else{var u=yield i.default.getOtherPlayers();1==u.length&&(a.other_player_id=u[0].id),c=yield this._network.post(`/players/${o}/challenges`,a)}this.parse(c.data),this._session.setData({type:e,duration:t,score:r,challengeId:this.challengeId})}catch(e){return!1}return!0})}delete(){return s(this,void 0,void 0,function*(){const e="/players/"+this.getPlayerId()+"/challenges/"+this.challengeId;try{const t=(yield this._network.delete(e)).status;if(t>=200&&t<=299)return!0}catch(e){}return!1})}toJSON(){return JSON.stringify(this._data)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{getCurrentPlayer(){return new Promise((e,t)=>{e({id:FBInstant.player.getID(),name:FBInstant.player.getName(),photo:FBInstant.player.getPhoto()})})}getOtherPlayers(){return new Promise((e,t)=>{let n=new Array;n.push(this.getCurrentPlayer()),n.push(FBInstant.context.getPlayersAsync()),Promise.all(n).then(t=>{let n=t[0],s=t[1];var r=[];s.forEach(e=>{n.id!=e.getID()&&r.push({id:e.getID(),name:e.getName(),photo:e.getPhoto()})}),e(r)},()=>{e([])})})}getFriends(){return new Promise((e,t)=>{FBInstant.player.getConnectedPlayersAsync().then(t=>{var n=t.map(e=>({id:e.getID(),name:e.getName(),photo:e.getPhoto()}));e(n)},t=>{e([])})})}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(3),r=["points"];t.CurrencyService=class extends s.BaseService{constructor(){super(...arguments),this._currencies=r.slice(0)}addCurrency(e){null==this._currencies.find(t=>t==e)&&this._currencies.push(e)}clear(){this._currencies=[]}addCurrencies(e){Array.isArray(e)&&e.forEach(e=>{this.addCurrency(e)})}get(){return this._currencies}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Store=class{constructor(e={}){this.initial=e,this.clear()}get(e,t){return this.state.hasOwnProperty(e)?this.state[e]:t}set(e,t){this.state[e]=t}clear(){this.state=this.initial}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(3);class r extends s.BaseService{constructor(){super(),this.internalState={},this.publicState={},this._publicSession=new i(this),this.timezoneOffset=(new Date).getTimezoneOffset(),this.syncSession()}getPublicSession(){return this._publicSession}setPublicState(e){this.publicState=e}reset(){this.internalState={}}setData(e){this.mergeData(this.internalState,e),this.syncSession()}syncSession(){let e=Object.assign({},this.publicState);e[r.PAYLOAD_NS]=this.internalState;const t=FBInstant.player.getName(),n=FBInstant.player.getPhoto();e._mc={timezone_offset:this.timezoneOffset,name:t,avatar:n},FBInstant.setSessionData(e)}mergeData(e,t){Object.keys(t).forEach(n=>{e[n]=t[n]})}}r.PAYLOAD_NS="mc:sessionPayload",t.SessionService=r;class i{constructor(e){this._session=e}set(e){this._session.setPublicState(e),this._session.syncSession()}}t.PublicSession=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s="_mc:";class r{get(e){const t=s+e;return FBInstant.player.getDataAsync([t]).then(e=>t in e?e[t]:{})}set(e,t){let n={};return n[s+e]=t,FBInstant.player.setDataAsync(n)}flush(){return FBInstant.player.flushDataAsync()}}r.mcStoragePayload="mc:instantPayload",t.InstantStorage=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(3),r=n(1),i=n(60),o=n(13);t.MessagesService=class extends s.BaseService{_boot(){this.network=this.container.get(r.Modules.NETWORK),this.listeners=new o.CallbackContainer,this.messageHandler=this.handler.bind(this)}send(e,t,n=null){return new Promise((s,r)=>{var o=new i.PostRequest(e,t,new a(n));this.network.send(o).then(e=>{s(!0)},e=>{r(e)})})}listen(e,t){this.listeners.hasFor(e)||this.network.getWS().registerPostHandler(e,this.messageHandler),this.listeners.add(e,t)}unlisten(e,t){this.listeners.remove(e,t),this.listeners.hasFor(e)||this.network.getWS().unregisterPostHandler(e,this.messageHandler)}handler(e){let t=this.listeners.get(e.id);null!=t&&t.forEach(t=>{t(e.id,e.sender_id,e.payload.data)})}};class a{constructor(e){this.data=null,this.data=e}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(2),r=n(5);t.PostRequest=class{constructor(e,t,n,r=s.ResponseTypes.OK,i=2){this.type=e,this.recipientID=t,this.responseType=r,this.payload=n||{requestID:"",okConfirmation:!1},this.payload.requestID=this.payload.requestID||`${t}_${(new Date).getTime()}`,this.payload.okConfirmation=this.responseType===s.ResponseTypes.OK,this.retries=i}send(e){const t=new r.SocketMessageHandler(e);let n=0;return new Promise((r,i)=>{const o=()=>{t.unregisterPostHandler(this.responseType,this.handleSuccess),t.unregisterHandler(s.ResponseTypes.POST_FAILURE,this.handleError),e.unregisterHandler("close",this.handleError),clearInterval(this.sendMessageLooper),this.sendMessageLooper=void 0};this.handleSuccess=(e=>{e.payload.requestID===this.payload.requestID&&(o(),r(e))}),this.handleError=(e=>{const t=null!=e&&"reason"in e?e.reason:"";o(),i(t)});const a=()=>{if(n++>this.retries)return o(),void i();e.send(this.stringify()),this.responseType||r()};this.responseType&&(t.registerPostHandler(this.responseType,this.handleSuccess),t.registerHandler(s.ResponseTypes.POST_FAILURE,this.handleError),e.registerHandler("close",this.handleError),this.sendMessageLooper=setInterval(a,1e3)),a()})}stringify(){const e={type:s.ResponseTypes.POST,recipient_id:this.recipientID,payload:this.payload,id:this.type};return JSON.stringify(e)}}},function(e,t,n){"use strict";var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))(function(r,i){function o(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(o,a)}c((s=s.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=n(3),i=n(1),o=n(4),a=n(16),c=n(62),u=n(2);t.LobbyService=class extends r.BaseService{constructor(){super(...arguments),this.connectedFriends=[],this.onlineFriends=[]}_boot(){this.network=this.container.get(i.Modules.NETWORK),this.network.getWS().onConnect.listen(this.onWSConnect.bind(this)),this.network.getWS().registerHandler(u.ResponseTypes.FRIEND_ONLINE,this.onFriendOnline.bind(this))}getOnlineFriends(){return this.onlineFriends}onWSConnect(){this.updateOnlineFriends()}onFriendOnline(e){"friend_online"==e.type&&this.addOnlineFriend(e.player_id)}addOnlineFriend(e,t=!0){const n=this.connectedFriends.find(t=>t.id==e);if(null==n)return;let s,r=this.onlineFriends.findIndex(t=>t.id==e);-1==r?(s={id:e,name:n.name,photo:n.photo,updated_at:(new Date).getTime()},this.onlineFriends.push(s)):((s=this.onlineFriends[r]).updated_at=(new Date).getTime(),this.onlineFriends[r]=s),t&&this.events.emit(o.EVENT_FRIEND_ONLINE,s)}updateOnlineFriends(){return s(this,void 0,void 0,function*(){const e=[];this.connectedFriends=yield a.default.getFriends(),this.connectedFriends.forEach(t=>{e.push(t.id)}),this.network.getWS().registerHandler(u.ResponseTypes.ONLINE_FRIENDS,e=>{"online_friends"==e.type&&e.friends.forEach(e=>{this.addOnlineFriend(e,!1)})}),this.network.send(new c.OnlineFriendsRequest(e))})}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(2),r=n(5);t.OnlineFriendsRequest=class{constructor(e,t=2){this.friendsIds=e,this.retries=t}send(e){const t=new r.SocketMessageHandler(e);let n=0;return new Promise((r,i)=>{this.sendMessage=(()=>{if(n++>this.retries)return t.unregisterHandler(s.ResponseTypes.ONLINE_FRIENDS,this.handleSuccess),e.unregisterHandler("error",this.sendMessage),void i();e.send(this.stringify())}),this.handleSuccess=(()=>r()),t.registerHandler(s.ResponseTypes.ONLINE_FRIENDS,this.handleSuccess),e.registerHandler("error",this.sendMessage),this.sendMessage()})}stringify(){const e={type:"get_online_friends",friends:this.friendsIds};return JSON.stringify(e)}}}])});
//# sourceMappingURL=mcinstant.js.map